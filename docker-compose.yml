services:
  # Reverse proxy - handles HTTPS and routing for public services
  traefik:
    image: traefik:v3.6.2
    container_name: traefik-reverse-proxy
    command:
      - --api.dashboard=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --ping=true
      - --ping.entrypoint=traefik
    ports:
      - 80:80
      - 443:443
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./configs/traefik/letsencrypt:/letsencrypt
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.${DOMAIN}`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.middlewares=auth,rate-limit-app"
      - "traefik.http.middlewares.auth.basicauth.users=${TRAEFIK_BASIC_AUTH}"
      # Rate limiting middleware definitions
      - "traefik.http.middlewares.rate-limit-plex.ratelimit.average=100"
      - "traefik.http.middlewares.rate-limit-plex.ratelimit.burst=50"
      - "traefik.http.middlewares.rate-limit-plex.ratelimit.period=1m"
      - "traefik.http.middlewares.rate-limit-app.ratelimit.average=500"
      - "traefik.http.middlewares.rate-limit-app.ratelimit.burst=100"
      - "traefik.http.middlewares.rate-limit-app.ratelimit.period=1m"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - proxy
      - media
      - automation
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # VPN container - routes Deluge traffic through NordVPN
  gluetun:
    image: qmcgaw/gluetun:v3.39.0
    container_name: gluetun-vpn
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - 8112:8112  # Deluge Web UI
      - 6881:6881  # Deluge incoming torrent connections
      - 6881:6881/udp
      - 127.0.0.1:58846:58846  # Deluge daemon
    volumes:
      - ./configs/gluetun:/gluetun
    environment:
      - VPN_SERVICE_PROVIDER=nordvpn
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${NORDVPN_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${NORDVPN_ADDRESSES}
      - SERVER_HOSTNAMES=us5500.nordvpn.com
      - TZ=${TZ:-America/Chicago}
      - FIREWALL_OUTBOUND_SUBNETS=172.16.0.0/12  # Allow all Docker bridge networks
      - HTTPPROXY=off
      - SHADOWSOCKS=off
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - download
      - automation
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  plex:
    image: plexinc/pms-docker:1.42.2.10156-f737b826c
    container_name: plex-media-server
    environment:
      - TZ=${TZ:-America/Chicago}
      - PLEX_CLAIM=${PLEX_CLAIM_TOKEN}
    ports:
      - 32400:32400/tcp
      - 1900:1900/udp
      - 3005:3005/tcp
      - 8324:8324/tcp
      - 32410:32410/udp
      - 32412:32412/udp
      - 32413:32413/udp
      - 32414:32414/udp
      - 32469:32469/tcp
    volumes:
      - ./configs/plex:/config
      - /tmp/plex:/transcode
      - /Volumes/Samsung_T5:/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.plex.rule=Host(`plex.${DOMAIN}`)"
      - "traefik.http.routers.plex.entrypoints=websecure"
      - "traefik.http.routers.plex.tls.certresolver=letsencrypt"
      - "traefik.http.routers.plex.middlewares=rate-limit-plex"
      - "traefik.http.services.plex.loadbalancer.server.port=32400"
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:32400/web/index.html"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - proxy
      - media
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  tautulli:
    image: lscr.io/linuxserver/tautulli:2.16.0
    container_name: tautulli-plex-monitoring
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./configs/tautulli:/config
      - ./configs/plex:/plex-logs:ro
    ports:
      - 8181:8181
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - media
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  radarr:
    image: lscr.io/linuxserver/radarr:6.0.4
    container_name: radarr-movie-management
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./configs/radarr:/config
      - /Volumes/Samsung_T5:/data
    ports:
      - 7878:7878
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7878/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - automation
      - download
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  sonarr:
    image: lscr.io/linuxserver/sonarr:4.0.16
    container_name: sonarr-tv-management
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./configs/sonarr:/config
      - /Volumes/Samsung_T5:/data
    ports:
      - 8989:8989
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8989/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - automation
      - download
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  bazarr:
    image: lscr.io/linuxserver/bazarr:1.5.3
    container_name: bazarr-subtitle-manager
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./configs/bazarr:/config
      - /Volumes/Samsung_T5:/data
    ports:
      - 6767:6767
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6767"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - automation
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  overseerr:
    image: sctx/overseerr:1.34.0
    container_name: overseerr-request-manager
    environment:
      - LOG_LEVEL=debug
      - TZ=${TZ:-America/Chicago}
      - PORT=5055
    ports:
      - 5055:5055
    volumes:
      - ./configs/overseerr:/app/config
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.overseerr.rule=Host(`requests.${DOMAIN}`)"
      - "traefik.http.routers.overseerr.entrypoints=websecure"
      - "traefik.http.routers.overseerr.tls.certresolver=letsencrypt"
      - "traefik.http.routers.overseerr.middlewares=rate-limit-app"
      - "traefik.http.services.overseerr.loadbalancer.server.port=5055"
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5055/api/v1/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - proxy
      - automation
      - media
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  homarr:
    image: ghcr.io/homarr-labs/homarr:v1.45.0
    container_name: homarr-dashboard
    environment:
      - TZ=${TZ:-America/Chicago}
      - SECRET_ENCRYPTION_KEY=${HOMARR_SECRET_ENCRYPTION_KEY}
      - HOSTNAME=0.0.0.0
    ports:
      - 7575:3000
    volumes:
      - ./configs/homarr/v1-data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.homarr.rule=Host(`home.${DOMAIN}`)"
      - "traefik.http.routers.homarr.entrypoints=websecure"
      - "traefik.http.routers.homarr.tls.certresolver=letsencrypt"
      - "traefik.http.services.homarr.loadbalancer.server.port=3000"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD-SHELL", "nc -z 127.0.0.1 3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - proxy
      - automation
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  deluge:
    image: lscr.io/linuxserver/deluge:2.2.0
    container_name: deluge-torrent-client
    network_mode: "service:gluetun"  # Route all traffic through VPN
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
      - DELUGE_LOGLEVEL=error #optional
    volumes:
      - ./configs/deluge:/config
      - /Volumes/Samsung_T5:/data
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8112"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    depends_on:
      - gluetun
    restart: on-failure:5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:2.3.0.5236-ls133
    container_name: prowlarr-indexer-manager
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./configs/prowlarr:/config
    ports:
      - 9696:9696
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9696/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - automation
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  health-monitor:
    build: ./monitoring
    container_name: health-monitor-alerts
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:rw
      - /Volumes/Samsung_T5:/data:ro
      - ./logs:/logs
    environment:
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - DISK_SPACE_THRESHOLD=${DISK_SPACE_THRESHOLD:-10}
      - ALERT_COOLDOWN=${ALERT_COOLDOWN:-3600}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - AUTO_RESTART_ENABLED=${AUTO_RESTART_ENABLED:-true}
      - RESTART_GRACE_PERIOD=${RESTART_GRACE_PERIOD:-60}
      - RESTART_COOLDOWN=${RESTART_COOLDOWN:-900}
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD", "test", "-f", "/logs/.health_monitor_running"]
      interval: 5m
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - monitoring
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - traefik
      - gluetun
      - plex
      - radarr
      - sonarr
      - bazarr
      - prowlarr
      - overseerr

  backup:
    build: ./backup
    container_name: backup-automation
    volumes:
      - .:/workspace
      - ./backup/rclone.conf:/root/.config/rclone/rclone.conf:ro
      - ./logs:/logs
    environment:
      - REMOTE_BACKUP_PATH=${REMOTE_BACKUP_PATH}
      - TZ=${TZ:-America/Chicago}
      - BACKUP_SCHEDULE=weekly
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /logs/.last_backup_success && test $(find /logs/.last_backup_success -mtime -8 | wc -l) -gt 0"]
      interval: 24h
      timeout: 10s
      retries: 1
      start_period: 10s
    networks:
      - monitoring
    working_dir: /workspace
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  compressor:
    build: ./compressor
    container_name: compressor-media-encoder
    profiles:
      - tools
    volumes:
      - /Volumes/Samsung_T5:/data
      - ./logs:/logs
    environment:
      - DOWNLOADS_DIR=/data/Downloads
      - MOVIES_DIR=/data/Movies
      - SHOWS_DIR=/data/Shows
      - COMPRESSION_CRF=${COMPRESSION_CRF:-23}
      - COMPRESSION_PRESET=${COMPRESSION_PRESET:-slow}
      - DRY_RUN=${DRY_RUN:-false}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - PLEX_URL=http://plex:32400
      - MIN_COMPRESSION_RATIO=${MIN_COMPRESSION_RATIO:-0.8}
      - DELUGE_HOST=${DELUGE_HOST:-gluetun}
      - DELUGE_PORT=${DELUGE_PORT:-8112}
      - DELUGE_PASSWORD=${DELUGE_PASSWORD}
      - TZ=${TZ:-America/Chicago}
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '1.0'
          memory: 2G
    networks:
      - media
      - download  # Access to gluetun for Deluge API
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  recyclarr:
    image: ghcr.io/recyclarr/recyclarr:7.4.1
    container_name: recyclarr-trash-guides
    profiles:
      - tools
    volumes:
      - ./configs/recyclarr:/config
    environment:
      - RADARR_API_KEY=${RADARR_API_KEY}
      - SONARR_API_KEY=${SONARR_API_KEY}
    working_dir: /config
    command: sync
    networks:
      - automation
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  watchtower:
    image: ghcr.io/containrrr/watchtower:1.7.1
    container_name: watchtower-update-monitor
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL=discord://${DISCORD_WEBHOOK_TOKEN}@${DISCORD_WEBHOOK_ID}
      - WATCHTOWER_SCHEDULE=0 0 4 * * *
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_CLEANUP=true
      - TZ=${TZ:-America/Chicago}
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    networks:
      - monitoring
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  fail2ban:
    image: lscr.io/linuxserver/fail2ban:1.1.0
    container_name: fail2ban-intrusion-prevention
    cap_add:
      - NET_ADMIN
      - NET_RAW
    network_mode: host
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/Chicago}
    volumes:
      - ./configs/fail2ban:/config
      - ./configs/radarr/logs:/remotelogs/radarr:ro
      - ./configs/sonarr/logs:/remotelogs/sonarr:ro
      - ./configs/prowlarr/logs:/remotelogs/prowlarr:ro
      - ./configs/overseerr/logs:/remotelogs/overseerr:ro
      - ./configs/plex/Library/Application Support/Plex Media Server/Logs:/remotelogs/plex:ro
      - ./logs:/logs:ro
      - /var/log:/var/log:ro
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  proxy:
    name: proxy
    driver: bridge
  media:
    name: media
    driver: bridge
  automation:
    name: automation
    driver: bridge
  download:
    name: download
    driver: bridge
  monitoring:
    name: monitoring
    driver: bridge
